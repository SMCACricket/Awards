<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMCA LeaderBoard</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles to handle the active class toggled by JS */
        .nav-button.active {
            background-color: #3b82f6; /* A vibrant blue for the active state */
            color: white;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 font-inter min-h-screen flex flex-col items-center p-4 md:p-8">

    <!-- Back to Home Button -->
    <a href="https://smcacricket.github.io/SMCACricket/" class="fixed top-4 left-4 z-20">
        <button class="bg-slate-700 hover:bg-slate-600 text-slate-200 font-bold py-2 px-4 rounded-lg shadow-md transition-colors">
            &larr; Back to Home
        </button>
    </a>

    <!-- Watermark - SMCA Logo placeholder -->
    <!-- The watermark now uses a lighter text color (#94a3b8 which is slate-400) to be visible against the dark background. -->
    <div class="fixed inset-0 bg-[url('https://placehold.co/1000x1000/1e293b/94a3b8?text=SMCA')] bg-no-repeat bg-center bg-[40%] opacity-20 pointer-events-none z-0"></div>

    <h1 class="text-white text-3xl md:text-5xl font-bold mt-8 mb-10 tracking-wide text-center drop-shadow-md z-10">SMCA Awards 2025</h1>

    <div class="navbar flex justify-center w-full max-w-4xl bg-slate-800 rounded-xl shadow-xl mb-8 overflow-hidden z-10">
        <button type="button" class="nav-button flex-1 py-4 px-6 text-lg font-semibold text-slate-200 hover:bg-slate-700 transition-colors" id="leaderboardNavBtn">Leaderboard</button>
        <button type="button" class="nav-button flex-1 py-4 px-6 text-lg font-semibold text-slate-200 hover:bg-slate-700 transition-colors" id="mySubmissionsNavBtn">My Submissions</button>
    </div>

    <!-- Leaderboard Page -->
    <div id="leaderboardPage" class="page-content hidden w-full max-w-4xl bg-slate-800 p-6 md:p-8 rounded-xl shadow-xl mb-10 flex-col items-center z-10">
        <h2 class="text-blue-400 text-2xl md:text-3xl font-bold mt-6 md:mt-10 mb-6 text-center border-b-2 border-blue-400 pb-2 w-full">5 Wicket Hauls</h2>
        <div id="five-wicket-hauls-table-container" class="w-full">
            <p class="loading-message text-center text-slate-400 italic p-4">Loading 5 Wicket Hauls...</p>
        </div>

        <h2 class="text-blue-400 text-2xl md:text-3xl font-bold mt-6 md:mt-10 mb-6 text-center border-b-2 border-blue-400 pb-2 w-full">Hat Tricks</h2>
        <div id="hat-tricks-table-container" class="w-full">
            <p class="loading-message text-center text-slate-400 italic p-4">Loading Hat Tricks...</p>
        </div>

        <h2 class="text-blue-400 text-2xl md:text-3xl font-bold mt-6 md:mt-10 mb-6 text-center border-b-2 border-blue-400 pb-2 w-full">Centuries</h2>
        <div id="centuries-table-container" class="w-full">
            <p class="loading-message text-center text-slate-400 italic p-4">Loading Centuries...</p>
        </div>
    </div>

    <!-- My Submissions Page -->
    <div id="matchHistoryPage" class="page-content hidden w-full max-w-4xl bg-slate-800 p-6 md:p-8 rounded-xl shadow-xl mb-10 flex-col items-center z-10">
        <h2 class="text-blue-400 text-2xl md:text-3xl font-bold mt-6 md:mt-10 mb-6 text-center border-b-2 border-blue-400 pb-2 w-full">My Submissions History</h2>
        <div class="submission-filters flex flex-wrap gap-4 justify-center items-end mb-8 w-full max-w-xl">
            <div class="flex-1 min-w-[12rem]">
                <label for="historyDivision" class="block mb-2 font-bold text-sm text-slate-300">Division:</label>
                <select id="historyDivision" class="w-full p-3 border-2 border-slate-600 bg-slate-700 text-slate-100 rounded-lg focus:outline-none focus:border-blue-500 transition-colors">
                    <option value="">Select Division</option>
                    <option value="Division 1">Division 1</option>
                    <option value="Division 2">Division 2</option>
                    <option value="Division 3">Division 3</option>
                    <option value="Division 4">Division 4</option>
                    <option value="Division 5">Division 5</option>
                    <option value="Division 6">Division 6</option>
                    <option value="Division 7">Division 7</option>
                    <option value="Division 8">Division 8</option>
                    <option value="Division 9">Division 9</option>
                    <option value="Division 10">Division 10</option>
                    <option value="Division 11">Division 11</option>
                    <option value="Division 12">Division 12</option>
                    <option value="Division 13">Division 13</option>
                    <option value="Division 14">Division 14</option>
                    <option value="Division 15">Division 15</option>
                    <option value="Division 16">Division 16</option>
                    <option value="Division 17">Division 17</option>
                    <option value="Division 18">Division 18</option>
                    <option value="Division 19">Division 19</option>
                    <option value="Division 20">Division 20</option>
                    <option value="Division 21">Division 21</option>
                    <option value="Division 22">Division 22</option>
                    <option value="Division 23">Division 23</option>
                    <option value="Division 24">Division 24</option>
                    <option value="Division 25">Division 25</option>
                    <option value="Division 26">Division 26</option>
                </select>
            </div>
            <div class="flex-1 min-w-[12rem]">
                <label for="historyTeam" class="block mb-2 font-bold text-sm text-slate-300">Team:</label>
                <select id="historyTeam" class="w-full p-3 border-2 border-slate-600 bg-slate-700 text-slate-100 rounded-lg focus:outline-none focus:border-blue-500 transition-colors" disabled>
                    <option value="">Select Team</option>
                    <!-- Teams will be populated dynamically based on division -->
                </select>
            </div>
            <button id="viewHistoryBtn" class="px-6 py-3 bg-green-600 text-white font-bold rounded-lg shadow-lg hover:bg-green-700 transition-transform transform hover:-translate-y-1">View Matches</button>
        </div>

        <div id="matchHistoryResults" class="w-full">
            <p class="loading-message text-center text-slate-400 italic p-4">Select a Division and Team to view their submission history.</p>
            <!-- Table will be populated here dynamically -->
        </div>
    </div>

    <script>
        let divisionTeamsDataCache = [];
        // IMPORTANT: Replace with the URL of your deployed display_script.gs
        const DISPLAY_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyRNzUwLZ-A4NPNEnqS4aCu0_5ZjEPJY9DVvWHhHt1C77MLvebGpo5JkiJ4vRNJMj8hTQ/exec';

        function showPage(pageId, clickedButton) {
            const allPages = document.querySelectorAll('.page-content');
            allPages.forEach(page => page.classList.remove('flex'));
            allPages.forEach(page => page.classList.add('hidden'));

            const selectedPage = document.getElementById(pageId);
            selectedPage.classList.remove('hidden');
            selectedPage.classList.add('flex');

            const navButtons = document.querySelectorAll('.nav-button');
            navButtons.forEach(button => button.classList.remove('active'));

            if (clickedButton) {
                clickedButton.classList.add('active');
            }

            if (pageId === 'leaderboardPage') {
                loadLeaderboardData('5 Wicket Hauls', 'five-wicket-hauls-table-container');
                loadLeaderboardData('Hat Tricks', 'hat-tricks-table-container');
                loadLeaderboardData('Centuries', 'centuries-table-container');
            }
            if (pageId === 'matchHistoryPage') {
                const selectedHistoryDivision = document.getElementById('historyDivision').value;
                if (selectedHistoryDivision) {
                    fetchAndPopulateHistoryTeams(selectedHistoryDivision);
                } else {
                    const historyTeamDropdown = document.getElementById('historyTeam');
                    historyTeamDropdown.innerHTML = '<option value="">Select Division first</option>';
                    historyTeamDropdown.disabled = true;
                }
            }
        }

        async function fetchAndPopulateHistoryTeams(selectedDivision) {
            const historyTeamDropdown = document.getElementById('historyTeam');
            historyTeamDropdown.innerHTML = '<option value="">Loading teams...</option>';
            historyTeamDropdown.disabled = true;

            if (!selectedDivision) {
                historyTeamDropdown.innerHTML = '<option value="">Select Division first</option>';
                historyTeamDropdown.disabled = true;
                return;
            }

            if (divisionTeamsDataCache.length === 0 || !divisionTeamsDataCache.some(item => item[0] === selectedDivision)) {
                try {
                    const response = await fetch(`${DISPLAY_SCRIPT_URL}?sheetname=${encodeURIComponent(selectedDivision)}`, {
                        mode: 'cors'
                    });
                    const data = await response.json();
                    divisionTeamsDataCache = data.teams || [];
                } catch (error) {
                    console.error('Error fetching history teams:', error);
                    historyTeamDropdown.innerHTML = '<p style="color: red;">Error loading teams</p>';
                    historyTeamDropdown.disabled = true;
                    return;
                }
            }

            historyTeamDropdown.innerHTML = '';
            const defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.text = "Select Team";
            historyTeamDropdown.add(defaultOption);

            const teamsInDivision = divisionTeamsDataCache.filter(item => item[0] === selectedDivision);
            const uniqueTeams = [...new Set(teamsInDivision.map(item => item[1]))].sort();

            uniqueTeams.forEach(teamName => {
                const option = document.createElement("option");
                option.text = teamName;
                option.value = teamName;
                historyTeamDropdown.add(option);
            });

            if (uniqueTeams.length === 0) {
                historyTeamDropdown.innerHTML = '<option value="">No teams in this division</option>';
                historyTeamDropdown.disabled = true;
            } else {
                historyTeamDropdown.disabled = false;
            }
        }

        document.getElementById('historyDivision').addEventListener('change', async (event) => {
            const selectedDivision = event.target.value;
            document.getElementById('matchHistoryResults').innerHTML = '<p class="loading-message text-center text-slate-400 italic p-4">Select a Division and Team to view their submission history.</p>';
            await fetchAndPopulateHistoryTeams(selectedDivision);
        });

        document.getElementById('viewHistoryBtn').addEventListener('click', async () => {
            const selectedDivision = document.getElementById('historyDivision').value;
            const selectedTeam = document.getElementById('historyTeam').value;
            const resultsDiv = document.getElementById('matchHistoryResults');

            if (!selectedDivision || !selectedTeam) {
                resultsDiv.innerHTML = '<p class="text-red-400 text-center p-4">Please select both a Division and a Team.</p>';
                return;
            }

            resultsDiv.innerHTML = `<p class="loading-message text-center text-slate-400 italic p-4">Loading match history for ${selectedTeam} in ${selectedDivision}...</p>`;

            try {
                const response = await fetch(`${DISPLAY_SCRIPT_URL}?division=${encodeURIComponent(selectedDivision)}&teamName=${encodeURIComponent(selectedTeam)}`, {
                    mode: 'cors'
                });
                const result = await response.json();

                if (result.error) {
                    resultsDiv.innerHTML = `<p class="text-red-400 text-center p-4">Error: ${result.error}</p>`;
                    console.error("API Error:", result.error);
                    return;
                }

                const filteredData = result.data;

                if (filteredData && filteredData.length > 0) {
                    let tableHtml = `
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse mt-6 mb-8 bg-slate-700 rounded-lg overflow-hidden shadow-md">
                                <thead>
                                    <tr class="bg-slate-600 text-slate-200">
                                        <th class="p-4 text-left font-semibold text-sm md:text-base uppercase">Date</th>
                                        <th class="p-4 text-left font-semibold text-sm md:text-base uppercase">Division</th>
                                        <th class="p-4 text-left font-semibold text-sm md:text-base uppercase">Team Name</th>
                                        <th class="p-4 text-left font-semibold text-sm md:text-base uppercase">Round</th>
                                        <th class="p-4 text-left font-semibold text-sm md:text-base uppercase">Match</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    filteredData.forEach(row => {
                        tableHtml += `
                            <tr>
                                <td data-label="Date" class="p-4 border-b border-slate-600 text-slate-300">${row.timestamp}</td>
                                <td data-label="Division" class="p-4 border-b border-slate-600 text-slate-300">${row.division}</td>
                                <td data-label="Team Name" class="p-4 border-b border-slate-600 text-slate-300">${row.teamName}</td>
                                <td data-label="Round" class="p-4 border-b border-slate-600 text-slate-300">${row.round}</td>
                                <td data-label="Match" class="p-4 border-b border-slate-600 text-slate-300">${row.match}</td>
                            </tr>
                        `;
                    });
                    tableHtml += `</tbody></table></div>`;
                    resultsDiv.innerHTML = tableHtml;
                } else {
                    resultsDiv.innerHTML = '<p class="no-data text-center text-slate-400 italic p-4">No submission history found for this team in the selected division.</p>';
                }
            } catch (error) {
                resultsDiv.innerHTML = '<p class="text-red-400 text-center p-4">Failed to load history. Please try again later.</p>';
                console.error("Fetch history error:", error);
            }
        });

        async function loadLeaderboardData(leaderboardType, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<p class="loading-message text-center text-slate-400 italic p-4">Loading ${leaderboardType} data...</p>`;

            let headersToDisplay = [];
            let columnTitles = [];

            if (leaderboardType === '5 Wicket Hauls') {
                headersToDisplay = ['player', 'figures', 'ground', 'team', 'division'];
                columnTitles = ['Player', 'Figures', 'Ground', 'Team' ,'Division'];
            } else if (leaderboardType === 'Hat Tricks') {
                headersToDisplay = ['player', 'figures', 'ground', 'team', 'division'];
                columnTitles = ['Player', 'Figures', 'Ground', 'Team','Division'];
            } else if (leaderboardType === 'Centuries') {
                headersToDisplay = [ 'player', 'score', 'ground', 'team','division'];
                columnTitles = ['Player', 'Score', 'Ground', 'Team','Division'];
            } else {
                container.innerHTML = `<p class="text-red-400 text-center p-4">Unknown leaderboard type: ${leaderboardType}</p>`;
                return;
            }

            try {
                const response = await fetch(`${DISPLAY_SCRIPT_URL}?type=leaderboard&leaderboardType=${encodeURIComponent(leaderboardType)}`, {
                    mode: 'cors'
                });
                const result = await response.json();

                if (result.error) {
                    container.innerHTML = `<p class="text-red-400 text-center p-4">Error loading ${leaderboardType}: ${result.error}</p>`;
                    console.error(`API Error for ${leaderboardType}:`, result.error);
                    return;
                }

                const data = result.data;

                if (data && data.length > 0) {
                    let tableHtml = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-600 rounded-lg shadow-md">
                            <thead class="bg-slate-700">
                                <tr class="bg-slate-600 text-slate-200">
                    `;
                    columnTitles.forEach(title => {
                        tableHtml += `<th class="p-4 text-left font-semibold text-sm md:text-base uppercase">${title}</th>`;
                    });
                    tableHtml += `</tr></thead><tbody>`;

                    data.forEach(row => {
                        tableHtml += `
                            <tr class="bg-slate-700 hover:bg-slate-600 transition-colors">
                        `;
                        headersToDisplay.forEach(key => {
                            const value = row[key] !== undefined ? row[key] : '';
                            const dataLabel = columnTitles[headersToDisplay.indexOf(key)];
                            tableHtml += `<td data-label="${dataLabel}" class="p-4 border-b border-slate-600 text-slate-300">${value}</td>`;
                        });
                        tableHtml += `</tr>`;
                    });
                    tableHtml += `</tbody></table></div>`;
                    container.innerHTML = tableHtml;
                } else {
                    container.innerHTML = `<p class="no-data text-center text-slate-400 italic p-4">No ${leaderboardType} data available yet.</p>`;
                }
            } catch (error) {
                container.innerHTML = `<p class="text-red-400 text-center p-4">Failed to load ${leaderboardType}. Please try again later.</p>`;
                console.error(`Fetch error for ${leaderboardType}:`, error);
            }
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            document.getElementById('leaderboardNavBtn').addEventListener('click', function() {
                showPage('leaderboardPage', this);
            });
            document.getElementById('mySubmissionsNavBtn').addEventListener('click', function() {
                showPage('matchHistoryPage', this);
            });
            showPage('leaderboardPage', document.getElementById('leaderboardNavBtn'));
        });
    </script>
</body>
</html>
